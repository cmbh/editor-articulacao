<!DOCTYPE html>
<html>

<head>
    <script src="silegismg-editor-articulacao-plain-js.js"></script>
</head>

<body>
    <h1 style="margin-top: 2em">Teste do editor de articulação</h1>
    <h2>Editor</h2>

    <!-- Barra de ferramentas para alterar formatação de dispositivos -->
    <div style="position: fixed; top: 0; left: 0; right: 0; padding: 1ex; background: #ccc">
        <button data-tipo-destino="titulo">Título</button>
        <button data-tipo-destino="capitulo">Capítulo</button>
        <button data-tipo-destino="secao">Seção</button>
        <button data-tipo-destino="subsecao">Subseção</button>
        <button data-tipo-destino="continuacao">Continuação</button>
        <button data-tipo-destino="artigo">Artigo</button>
        <button data-tipo-destino="paragrafo">Parágrafo</button>
        <button data-tipo-destino="inciso">Inciso</button>
        <button data-tipo-destino="alinea">Alínea</button>
        <button data-tipo-destino="item">Item</button>
    </div>

    <!-- Painel informativo, com dados do contexto de edição (para desenvolvedores) -->
    <pre id="contexto" style="position: fixed; top: 3.8em; right: 0; background: black; box-shadow: 0px 0px 20px gray; margin: 0; opacity: .3; font-size: 75%; color: white"></pre>

    <!-- Elemento que será transformado no editor de articulação -->
    <div id="articulacao"></div>
    
    <!-- Resultado final, em LexML -->
    <hr>
    <pre id="lexml"></pre>

    <!-- Botão apenas para exemplificar obtenção de dados -->
    <button id="importarConstituicao">Importar LexML da Constituição Federal</button>


    <script>
        // Transforma o elemento com id="articulacao" em um editor de articulação, salvando o controlador na variável ctrl.
        var ctrl = silegismgEditorArticulacao(document.getElementById('articulacao'), {
            // Define-se a formatação no padrão federal
            rotulo: {
                separadorArtigo: '',
                separadorArtigoSemOrdinal: '.',
                separadorParagrafo: '',
                separadorParagrafoSemOrdinal: '.'
            }
        });

        // O controlador ctrl também está disponível em document.getElementById('articulacao').ctrlArticulacao.
    </script>

    <script>
        // Para cada botão definido na barra de ferramentas, executa a simples ação de alterar o tipo do dispositivo selecionado
        let botoes = document.querySelectorAll('button[data-tipo-destino]');

        for (let i = 0; i < botoes.length; i++) {
            botoes[i].onclick = function (event) {
                articulacao.ctrlArticulacao.alterarTipoDispositivoSelecionado(event.target.getAttribute('data-tipo-destino'));
                articulacao.focus();
            }
        }
    </script>

    <script>
        /* Monitora atualização do contexto do usuário no editor de articulação,
         * controlando habilitação de botões de transformação de dispositivo.
         * 
         * A atualização é feita por meio do evento "contexto" no DOM.
         */
        document.getElementById('articulacao').addEventListener('contexto', function (evento) {
            /* Os botões de transformação de dispositivo só sõ habilitados se for possível
             * usar o dispositivo onde o cursor estiver.
             */
            for (let i = 0; i < botoes.length; i++) {
                botoes[i].disabled = !evento.detail.permissoes[botoes[i].getAttribute('data-tipo-destino')];
            }

            // Apenas para fins demonstrativos, exibe-se o conteúdo do JSON do contexto no elemento de id="contexto".
            try {
                document.getElementById('contexto').innerText = 'Permissões: ' + JSON.stringify(evento.detail.permissoes, null, 4) + '\nCursor: ' + JSON.stringify(evento.detail.cursor, null, 4);
            } catch (e) {
                document.getElementById('contexto').innerText = '';
            }
        });

        // Quando houver alteração na articulação, exibe-se o LexML.
        document.getElementById('articulacao').addEventListener('change', function () {
            lexml.textContent = !ctrl.vazio ? ctrl.lexmlString.replace(/(<\/.+?>)/g, '$1\n') : '';
        });

        importarConstituicao.onclick = function () {
            var req = new XMLHttpRequest();
            req.onload = function() {
                var lexml = this.responseText;
                var articulacao = /<Articulacao>([\s\S]*)<\/Articulacao>/.exec(lexml)[1]; // Obtém apenas a tag articulacao

                ctrl.lexmlString = articulacao;
            };
            req.open('get', 'https://raw.githubusercontent.com/lexml/lexml-xml-samples/master/LexML/CON1988--20150303.LexML.xml', true);
            req.send();
        }

        articulacao.focus();
    </script>
</body>

</html>